<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DoctorClaw</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root { --font-body: 'Outfit', sans-serif; --font-mono: 'DM Mono', monospace; --radius: 12px; --radius-sm: 8px; --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
  [data-theme="light"] {
    --bg-base: #F4F2EF; --bg-surface: #FFFFFF; --bg-surface-hover: #FAF9F7; --bg-inset: #EDEAE6;
    --bg-chat-user: #E8E5E0; --bg-chat-assistant: transparent; --border: #DDD9D3; --border-subtle: #E8E5E0;
    --text-primary: #1A1917; --text-secondary: #6B6762; --text-tertiary: #9C9790;
    --accent: #2D7A6F; --accent-hover: #236B61; --accent-subtle: #E6F3F0; --accent-text: #FFFFFF;
    --danger: #C74A4A; --danger-hover: #B03E3E; --danger-subtle: #FCEAEA;
    --success: #3A8F6E; --success-subtle: #E6F5EE; --warning: #C4890C; --warning-subtle: #FFF5E0;
    --code-bg: #F0EDE9; --tab-active: #FFFFFF; --tab-hover: #FAF9F7; --overlay: rgba(0,0,0,0.3);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.04); --shadow-md: 0 4px 16px rgba(0,0,0,0.06); --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
  }
  [data-theme="dark"] {
    --bg-base: #141413; --bg-surface: #1E1E1C; --bg-surface-hover: #252523; --bg-inset: #111110;
    --bg-chat-user: #2A2A27; --bg-chat-assistant: transparent; --border: #333330; --border-subtle: #2A2A27;
    --text-primary: #E8E5E0; --text-secondary: #9C9790; --text-tertiary: #6B6762;
    --accent: #4DC9B4; --accent-hover: #5DD9C4; --accent-subtle: #1A2F2B; --accent-text: #111110;
    --danger: #E06B6B; --danger-hover: #E88080; --danger-subtle: #2D1A1A;
    --success: #5CC99A; --success-subtle: #1A2D22; --warning: #E0A830; --warning-subtle: #2D2510;
    --code-bg: #252523; --tab-active: #252523; --tab-hover: #1E1E1C; --overlay: rgba(0,0,0,0.6);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.2); --shadow-md: 0 4px 16px rgba(0,0,0,0.3); --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
  }
  html { height: 100%; }
  body { font-family: var(--font-body); background: var(--bg-base); color: var(--text-primary); height: 100%; overflow: hidden; transition: background var(--transition), color var(--transition); }
  .app { display: flex; flex-direction: column; height: 100vh; max-width: 900px; margin: 0 auto; }
  .header { display: flex; align-items: center; justify-content: space-between; padding: 14px 24px; border-bottom: 1px solid var(--border-subtle); flex-shrink: 0; }
  .brand { display: flex; align-items: center; gap: 12px; }
  .brand-icon { width: 34px; height: 34px; background: var(--accent); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 17px; color: var(--accent-text); font-weight: 600; box-shadow: var(--shadow-sm); }
  .brand-text h1 { font-size: 16px; font-weight: 600; letter-spacing: -0.3px; line-height: 1.2; }
  .brand-text span { font-size: 11px; color: var(--text-tertiary); }
  .header-actions { display: flex; align-items: center; gap: 8px; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-tertiary); transition: background var(--transition); }
  .status-dot.ok { background: var(--success); } .status-dot.err { background: var(--danger); }
  .status-label { font-size: 12px; color: var(--text-tertiary); margin-right: 8px; }
  .btn-icon { width: 34px; height: 34px; border: 1px solid var(--border); background: var(--bg-surface); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all var(--transition); color: var(--text-secondary); }
  .btn-icon:hover { background: var(--bg-surface-hover); border-color: var(--text-tertiary); }
  .btn-icon svg { width: 17px; height: 17px; }
  .tabs-bar { display: flex; align-items: center; gap: 2px; padding: 8px 24px 0; border-bottom: 1px solid var(--border-subtle); flex-shrink: 0; overflow-x: auto; scrollbar-width: none; }
  .tabs-bar::-webkit-scrollbar { display: none; }
  .tab { display: flex; align-items: center; gap: 6px; padding: 8px 14px; font-family: var(--font-body); font-size: 12.5px; font-weight: 500; color: var(--text-tertiary); background: transparent; border: 1px solid transparent; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; white-space: nowrap; transition: all var(--transition); max-width: 180px; }
  .tab:hover { color: var(--text-secondary); background: var(--tab-hover); }
  .tab.active { color: var(--text-primary); background: var(--tab-active); border-color: var(--border-subtle); box-shadow: var(--shadow-sm); }
  .tab-label { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px; }
  .tab-close { width: 16px; height: 16px; border: none; background: transparent; color: var(--text-tertiary); cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0; flex-shrink: 0; transition: all var(--transition); }
  .tab-close:hover { background: var(--danger-subtle); color: var(--danger); }
  .tab-new { padding: 8px 10px; font-family: var(--font-body); font-size: 16px; color: var(--text-tertiary); background: transparent; border: 1px dashed var(--border); border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; transition: all var(--transition); flex-shrink: 0; display: flex; align-items: center; justify-content: center; width: 34px; }
  .tab-new:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-subtle); }
  .chat-area { flex: 1; overflow-y: auto; padding: 24px; scroll-behavior: smooth; }
  .chat-area::-webkit-scrollbar { width: 6px; } .chat-area::-webkit-scrollbar-track { background: transparent; } .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .welcome { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 16px; opacity: 0.8; }
  .welcome-icon { width: 64px; height: 64px; background: var(--accent-subtle); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
  .welcome h2 { font-size: 22px; font-weight: 600; letter-spacing: -0.5px; }
  .welcome p { font-size: 14px; color: var(--text-secondary); text-align: center; max-width: 400px; line-height: 1.6; }
  .message { margin-bottom: 20px; animation: msgIn 0.3s ease-out; } .message.no-anim { animation: none; }
  @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .message-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-tertiary); margin-bottom: 6px; padding-left: 2px; }
  .message-label.assistant-label { color: var(--accent); }
  .message-body { padding: 14px 18px; border-radius: var(--radius); font-size: 14.5px; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; }
  .message-body.user-body { background: var(--bg-chat-user); border: 1px solid var(--border-subtle); }
  .message-body.assistant-body { background: var(--bg-chat-assistant); }
  .message-body code { font-family: var(--font-mono); font-size: 13px; background: var(--code-bg); padding: 2px 6px; border-radius: 4px; }
  .message-body pre { background: var(--code-bg); padding: 12px 16px; border-radius: var(--radius-sm); overflow-x: auto; margin: 8px 0; border: 1px solid var(--border-subtle); }
  .message-body pre code { background: none; padding: 0; }
  .action-card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); margin: 12px 0; overflow: hidden; box-shadow: var(--shadow-sm); animation: msgIn 0.3s ease-out; }
  .action-card.no-anim { animation: none; }
  .action-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); background: var(--bg-inset); }
  .action-type-badge { font-family: var(--font-mono); font-size: 11px; font-weight: 500; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .action-type-badge.read { background: var(--accent-subtle); color: var(--accent); }
  .action-type-badge.cmd { background: var(--warning-subtle); color: var(--warning); }
  .action-type-badge.script { background: var(--warning-subtle); color: var(--warning); }
  .action-type-badge.write { background: var(--danger-subtle); color: var(--danger); }
  .action-target { font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
  .action-body { padding: 12px 16px; }
  .action-content-preview { font-family: var(--font-mono); font-size: 12px; background: var(--code-bg); padding: 10px 12px; border-radius: var(--radius-sm); margin-bottom: 12px; max-height: 120px; overflow-y: auto; white-space: pre-wrap; color: var(--text-secondary); border: 1px solid var(--border-subtle); }
  .action-buttons { display: flex; gap: 8px; }
  .btn { font-family: var(--font-body); font-size: 13px; font-weight: 500; padding: 8px 20px; border-radius: var(--radius-sm); border: none; cursor: pointer; transition: all var(--transition); display: inline-flex; align-items: center; gap: 6px; }
  .btn-approve { background: var(--accent); color: var(--accent-text); } .btn-approve:hover { background: var(--accent-hover); }
  .btn-deny { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); } .btn-deny:hover { background: var(--danger-subtle); color: var(--danger); border-color: var(--danger); }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .action-result { margin-top: 10px; padding: 10px 12px; border-radius: var(--radius-sm); font-family: var(--font-mono); font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; line-height: 1.5; }
  .action-result.success { background: var(--success-subtle); color: var(--success); border: 1px solid var(--success); }
  .action-result.failure { background: var(--danger-subtle); color: var(--danger); border: 1px solid var(--danger); }
  .action-result.denied { background: var(--bg-inset); color: var(--text-tertiary); border: 1px solid var(--border); }
  .streaming-dot { display: inline-block; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; margin-left: 4px; animation: blink 1s ease-in-out infinite; vertical-align: middle; }
  @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
  .input-area { padding: 16px 24px 24px; border-top: 1px solid var(--border-subtle); flex-shrink: 0; }
  .input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
  .input-field { flex: 1; font-family: var(--font-body); font-size: 14.5px; padding: 12px 16px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text-primary); resize: none; min-height: 46px; max-height: 160px; line-height: 1.5; transition: border var(--transition), box-shadow var(--transition); outline: none; }
  .input-field::placeholder { color: var(--text-tertiary); }
  .input-field:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-subtle); }
  .btn-send { width: 46px; height: 46px; background: var(--accent); color: var(--accent-text); border: none; border-radius: var(--radius); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all var(--transition); flex-shrink: 0; }
  .btn-send:hover { background: var(--accent-hover); transform: scale(1.04); }
  .btn-send:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .btn-send svg { width: 20px; height: 20px; }
  .input-hint { font-size: 11px; color: var(--text-tertiary); margin-top: 8px; text-align: center; }

  /* â”€â”€ Settings â”€â”€ */
  .settings-overlay { position: fixed; inset: 0; background: var(--overlay); z-index: 100; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s ease-out; }
  .settings-overlay.open { display: flex; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .settings-panel { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 16px; width: 90%; max-width: 540px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); animation: slideUp 0.25s ease-out; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  .settings-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 16px; border-bottom: 1px solid var(--border-subtle); flex-shrink: 0; }
  .settings-header h2 { font-size: 17px; font-weight: 600; letter-spacing: -0.3px; }
  .settings-close { width: 32px; height: 32px; border: none; background: transparent; color: var(--text-tertiary); cursor: pointer; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all var(--transition); }
  .settings-close:hover { background: var(--bg-inset); color: var(--text-primary); }
  .settings-body { padding: 20px 24px; overflow-y: auto; flex: 1; }
  .field { margin-bottom: 20px; }
  .field-label { font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 6px; display: block; }
  .field-hint { font-size: 11.5px; color: var(--text-tertiary); margin-bottom: 8px; line-height: 1.4; }
  .field-input { width: 100%; font-family: var(--font-mono); font-size: 13px; padding: 10px 14px; background: var(--bg-inset); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); outline: none; transition: border var(--transition); }
  .field-input:focus { border-color: var(--accent); }
  .path-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }
  .path-row { display: flex; gap: 6px; align-items: center; }
  .path-row .field-input { flex: 1; margin: 0; }
  .path-remove { width: 32px; height: 32px; border: 1px solid var(--border); background: transparent; color: var(--text-tertiary); cursor: pointer; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all var(--transition); flex-shrink: 0; }
  .path-remove:hover { background: var(--danger-subtle); color: var(--danger); border-color: var(--danger); }
  .path-add { font-family: var(--font-body); font-size: 12px; font-weight: 500; padding: 6px 14px; background: transparent; border: 1px dashed var(--border); border-radius: var(--radius-sm); color: var(--text-tertiary); cursor: pointer; transition: all var(--transition); display: inline-flex; }
  .path-add:hover { color: var(--accent); border-color: var(--accent); }
  .settings-footer { padding: 16px 24px 20px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-shrink: 0; }
  .save-msg { font-size: 12px; color: var(--success); flex: 1; } .save-msg.err { color: var(--danger); }
  .btn-save { font-family: var(--font-body); font-size: 13px; font-weight: 500; padding: 10px 24px; background: var(--accent); color: var(--accent-text); border: none; border-radius: var(--radius-sm); cursor: pointer; transition: all var(--transition); white-space: nowrap; }
  .btn-save:hover { background: var(--accent-hover); }

  /* â”€â”€ Stop button â”€â”€ */
  .btn-send.stopping { background: var(--danger); }
  .btn-send.stopping:hover { background: var(--danger-hover); }

  /* â”€â”€ Edit message â”€â”€ */
  .message-user-wrap { position: relative; }
  .message-edit-btn {
    position: absolute; right: 8px; top: 28px; width: 28px; height: 28px;
    border: 1px solid var(--border); background: var(--bg-surface); border-radius: var(--radius-sm);
    display: none; align-items: center; justify-content: center;
    cursor: pointer; color: var(--text-tertiary); transition: all var(--transition); z-index: 2;
  }
  .message-user-wrap:hover .message-edit-btn { display: flex; }
  .message-edit-btn:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-subtle); }
  .message-edit-btn svg { width: 14px; height: 14px; }
  .edit-container { margin-top: 8px; }
  .edit-textarea {
    width: 100%; font-family: var(--font-body); font-size: 14.5px; padding: 12px 16px;
    background: var(--bg-surface); border: 2px solid var(--accent); border-radius: var(--radius);
    color: var(--text-primary); resize: vertical; min-height: 60px; max-height: 200px;
    line-height: 1.5; outline: none; transition: border var(--transition);
  }
  .edit-actions { display: flex; gap: 8px; margin-top: 8px; justify-content: flex-end; }
  .edit-actions .btn { padding: 6px 16px; font-size: 12.5px; }
  .branch-notice { font-size: 11px; color: var(--text-tertiary); margin-top: 4px; font-style: italic; }

  /* â”€â”€ Settings Tabs â”€â”€ */
  .settings-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border-subtle); margin-bottom: 16px; }
  .settings-tab { padding: 10px 20px; font-family: var(--font-body); font-size: 13px; font-weight: 500; color: var(--text-tertiary); background: transparent; border: none; border-bottom: 2px solid transparent; cursor: pointer; transition: all var(--transition); }
  .settings-tab:hover { color: var(--text-secondary); }
  .settings-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .settings-tab-content { display: none; }
  .settings-tab-content.active { display: block; }

  /* â”€â”€ Toggle Switch â”€â”€ */
  .toggle-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 0; }
  .toggle-label-group { display: flex; flex-direction: column; gap: 2px; flex: 1; }
  .toggle-switch { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; position: absolute; }
  .toggle-slider { position: absolute; inset: 0; background: var(--border); border-radius: 12px; cursor: pointer; transition: all var(--transition); }
  .toggle-slider::before { content: ''; position: absolute; width: 18px; height: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: all var(--transition); }
  .toggle-switch input:checked + .toggle-slider { background: var(--accent); }
  .toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }

  /* â”€â”€ Audio / Mic Button â”€â”€ */
  .btn-audio { width: 46px; height: 46px; background: transparent; color: var(--text-secondary); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; display: none; align-items: center; justify-content: center; transition: all var(--transition); flex-shrink: 0; }
  .btn-audio.visible { display: flex; }
  .btn-audio:hover { background: var(--bg-surface-hover); border-color: var(--text-tertiary); }
  .btn-audio.recording { background: var(--danger-subtle); border-color: var(--danger); color: var(--danger); }
  .btn-audio.recording:hover { background: var(--danger-subtle); border-color: var(--danger-hover); }
  .btn-audio svg { width: 20px; height: 20px; }
  @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(199,74,74,0.4); } 70% { box-shadow: 0 0 0 8px rgba(199,74,74,0); } 100% { box-shadow: 0 0 0 0 rgba(199,74,74,0); } }
  .btn-audio.recording { animation: pulse-ring 1.5s ease-in-out infinite; }

  /* â”€â”€ TTS Speaking Indicator â”€â”€ */
  .tts-indicator { display: none; align-items: center; gap: 6px; font-size: 11px; color: var(--accent); padding: 4px 0; }
  .tts-indicator.active { display: flex; }
  .tts-bars { display: flex; gap: 2px; align-items: flex-end; height: 14px; }
  .tts-bar { width: 3px; background: var(--accent); border-radius: 1px; animation: tts-eq 0.8s ease-in-out infinite; }
  .tts-bar:nth-child(1) { height: 6px; animation-delay: 0s; }
  .tts-bar:nth-child(2) { height: 10px; animation-delay: 0.15s; }
  .tts-bar:nth-child(3) { height: 4px; animation-delay: 0.3s; }
  .tts-bar:nth-child(4) { height: 12px; animation-delay: 0.45s; }
  @keyframes tts-eq { 0%, 100% { transform: scaleY(0.4); } 50% { transform: scaleY(1); } }
  .tts-stop { background: none; border: none; color: var(--text-tertiary); cursor: pointer; font-size: 11px; font-family: var(--font-body); text-decoration: underline; padding: 0; transition: color var(--transition); }
  .tts-stop:hover { color: var(--danger); }

  @media (max-width: 640px) {
    .header { padding: 12px 16px; } .tabs-bar { padding: 8px 16px 0; } .chat-area { padding: 16px; } .input-area { padding: 12px 16px 20px; }
    .brand-text span { display: none; } .tab { max-width: 130px; padding: 7px 10px; }
    .settings-panel { width: 95%; max-height: 90vh; }
  }
</style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="brand">
      <div class="brand-icon">ðŸ©º</div>
      <div class="brand-text"><h1>DoctorClaw</h1><span>System Diagnostics</span></div>
    </div>
    <div class="header-actions">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-label" id="statusLabel">Checkingâ€¦</span>
      <button class="btn-icon" id="settingsBtn" title="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      </button>
      <button class="btn-icon" id="themeToggle" title="Toggle theme">
        <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>
    </div>
  </header>
  <div class="tabs-bar" id="tabsBar"><button class="tab-new" id="newTabBtn" title="New session">+</button></div>
  <div class="chat-area" id="chatArea"></div>
  <div class="input-area">
    <div class="input-wrapper">
      <textarea class="input-field" id="input" placeholder="Describe the issueâ€¦" rows="1"></textarea>
      <button class="btn-audio" id="audioBtn" title="Voice input">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
      </button>
      <button class="btn-send" id="sendBtn" title="Send">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
    <div class="input-hint">Actions require your explicit approval before execution</div>
    <div class="tts-indicator" id="ttsIndicator">
      <div class="tts-bars"><div class="tts-bar"></div><div class="tts-bar"></div><div class="tts-bar"></div><div class="tts-bar"></div></div>
      <span>Speakingâ€¦</span>
      <button class="tts-stop" id="ttsStopBtn">Stop</button>
    </div>
  </div>
</div>

<!-- Settings -->
<div class="settings-overlay" id="settingsOverlay">
  <div class="settings-panel">
    <div class="settings-header"><h2>Settings</h2><button class="settings-close" id="settingsClose">Ã—</button></div>
    <div class="settings-body">
      <div class="settings-tabs">
        <button class="settings-tab active" data-settings-tab="general">General</button>
        <button class="settings-tab" data-settings-tab="experimental">Experimental</button>
      </div>
      <div class="settings-tab-content active" id="settingsGeneral">
        <div class="field">
          <label class="field-label">Ollama URL</label>
          <input class="field-input" id="cfgOllamaUrl" type="text" placeholder="http://localhost:11434">
        </div>
        <div class="field">
          <label class="field-label">Model</label>
          <input class="field-input" id="cfgModel" type="text" placeholder="glm-4.7:cloud">
        </div>
        <div class="field">
          <label class="field-label">Port</label>
          <div class="field-hint">Requires restart to take effect.</div>
          <input class="field-input" id="cfgPort" type="number" placeholder="3333">
        </div>
        <div class="field">
          <label class="field-label">OpenClaw Directory</label>
          <div class="field-hint">Main directory of your OpenClaw installation. Automatically included in read and write paths.</div>
          <input class="field-input" id="cfgOpenclawDir" type="text" placeholder="/opt/openclaw">
        </div>
        <div class="field">
          <label class="field-label">Operating System</label>
          <div class="field-hint">Tells DoctorClaw which commands and shell syntax to use.</div>
          <select class="field-input" id="cfgOs">
            <option value="linux">Linux</option>
            <option value="macos">macOS</option>
            <option value="windows">Windows</option>
          </select>
        </div>
        <div class="field">
          <label class="field-label">Readable Paths</label>
          <div class="field-hint">Directories DoctorClaw is allowed to read from. Changes take effect immediately.</div>
          <div class="path-list" id="readPathsList"></div>
          <button class="path-add" id="addReadPath">+ Add path</button>
        </div>
        <div class="field">
          <label class="field-label">Writable Paths</label>
          <div class="field-hint">Directories DoctorClaw is allowed to write to. Changes take effect immediately.</div>
          <div class="path-list" id="writePathsList"></div>
          <button class="path-add" id="addWritePath">+ Add path</button>
        </div>
      </div>
      <div class="settings-tab-content" id="settingsExperimental">
        <div class="field">
          <div class="toggle-row">
            <div class="toggle-label-group">
              <label class="field-label" style="margin-bottom:0">Enable Audio Conversing</label>
              <div class="field-hint" style="margin-bottom:0">Talk to DoctorClaw using your microphone and hear responses spoken aloud via ElevenLabs.</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="cfgAudioEnabled">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        <div class="field">
          <label class="field-label">ElevenLabs API Key</label>
          <div class="field-hint">Required for text-to-speech. Get your key at <a href="https://elevenlabs.io" target="_blank" style="color:var(--accent)">elevenlabs.io</a>.</div>
          <input class="field-input" id="cfgElevenlabsKey" type="password" placeholder="xi-xxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off">
        </div>
        <div class="field">
          <label class="field-label">ElevenLabs Voice ID</label>
          <div class="field-hint">The voice to use for speech. Leave blank for the default voice (Rachel).</div>
          <input class="field-input" id="cfgElevenlabsVoice" type="text" placeholder="21m00Tcm4TlvDq8ikWAM">
        </div>
      </div>
    </div>
    <div class="settings-footer">
      <div class="save-msg" id="saveMsg"></div>
      <button class="btn-save" id="saveSettings">Save</button>
    </div>
  </div>
</div>

<script>
(function() {
  const SK='doctorclaw-sessions', AK='doctorclaw-active-session', AUDIO_KEY='doctorclaw-audio-enabled';
  function loadS(){try{return JSON.parse(localStorage.getItem(SK))||[];}catch{return[];}}
  function saveS(s){localStorage.setItem(SK,JSON.stringify(s));}
  function gAI(){return localStorage.getItem(AK);}
  function sAI(id){localStorage.setItem(AK,id);}
  let sessions=loadS(),activeId=gAI(),streaming=false,abortController=null;
  let audioEnabled=localStorage.getItem(AUDIO_KEY)==='true';
  const SEND_ICON='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>';
  const STOP_ICON='<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>';
  if(!sessions.length){const s=mkS();sessions.push(s);activeId=s.id;persist();}
  else if(!sessions.find(s=>s.id===activeId)){activeId=sessions[0].id;persist();}
  function mkS(){const n=new Date();return{id:'s_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),label:n.toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}),conversation:[],rendered:[],createdAt:n.toISOString()};}
  function cur(){return sessions.find(s=>s.id===activeId);}

  function persist(){
    saveS(sessions);
    sAI(activeId);
  }

  // Cross-tab sync: when another tab writes to localStorage, reload
  window.addEventListener('storage',e=>{
    if(e.key===SK&&!streaming){
      const fresh=loadS();
      // Preserve our active session's in-memory state if we're mid-conversation
      const currentActive=cur();
      sessions=fresh;
      if(currentActive){
        const idx=sessions.findIndex(s=>s.id===currentActive.id);
        if(idx>-1)sessions[idx]=currentActive;
      }
      renderTabs();renderChat();
    }
  });

  const chatArea=document.getElementById('chatArea'),input=document.getElementById('input'),sendBtn=document.getElementById('sendBtn'),
    tabsBar=document.getElementById('tabsBar'),newTabBtn=document.getElementById('newTabBtn'),themeToggle=document.getElementById('themeToggle'),
    statusDot=document.getElementById('statusDot'),statusLabel=document.getElementById('statusLabel'),
    audioBtn=document.getElementById('audioBtn'),ttsIndicator=document.getElementById('ttsIndicator'),ttsStopBtn=document.getElementById('ttsStopBtn');

  // Theme
  const st=localStorage.getItem('dc-theme')||'light';document.documentElement.setAttribute('data-theme',st);updTI();
  themeToggle.addEventListener('click',()=>{const nx=document.documentElement.getAttribute('data-theme')==='light'?'dark':'light';document.documentElement.setAttribute('data-theme',nx);localStorage.setItem('dc-theme',nx);updTI();});
  function updTI(){const d=document.documentElement.getAttribute('data-theme')==='dark';document.getElementById('themeIcon').innerHTML=d?'<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>':'<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';}

  // Health
  async function chk(){try{const r=await fetch('/api/health');const d=await r.json();statusDot.className=d.status==='ok'?'status-dot ok':'status-dot err';statusLabel.textContent=d.status==='ok'?'Connected':'Offline';}catch{statusDot.className='status-dot err';statusLabel.textContent='Offline';}}
  chk();setInterval(chk,15000);

  // Settings
  const sOverlay=document.getElementById('settingsOverlay'),sBtn=document.getElementById('settingsBtn'),sClose=document.getElementById('settingsClose'),saveBtn=document.getElementById('saveSettings'),saveMsg=document.getElementById('saveMsg');
  sBtn.addEventListener('click',openSettings);sClose.addEventListener('click',()=>sOverlay.classList.remove('open'));
  sOverlay.addEventListener('click',e=>{if(e.target===sOverlay)sOverlay.classList.remove('open');});

  // Settings tabs
  document.querySelectorAll('.settings-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      document.querySelectorAll('.settings-tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.settings-tab-content').forEach(c=>c.classList.remove('active'));
      tab.classList.add('active');
      const target=tab.getAttribute('data-settings-tab');
      document.getElementById(target==='general'?'settingsGeneral':'settingsExperimental').classList.add('active');
    });
  });

  async function openSettings(){
    saveMsg.textContent='';
    // Reset to General tab
    document.querySelectorAll('.settings-tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.settings-tab-content').forEach(c=>c.classList.remove('active'));
    document.querySelector('[data-settings-tab="general"]').classList.add('active');
    document.getElementById('settingsGeneral').classList.add('active');
    try{
      const r=await fetch('/api/config');const cfg=await r.json();
      document.getElementById('cfgOllamaUrl').value=cfg.ollama_url||'';
      document.getElementById('cfgModel').value=cfg.model||'';
      document.getElementById('cfgPort').value=cfg.port||'';
      document.getElementById('cfgOpenclawDir').value=cfg.openclaw_dir||'';
      document.getElementById('cfgOs').value=cfg.os||'linux';
      renderPL('readPathsList',cfg.read_paths||[]);
      renderPL('writePathsList',cfg.write_paths||[]);
      // Experimental fields
      document.getElementById('cfgAudioEnabled').checked=!!cfg.audio_enabled;
      document.getElementById('cfgElevenlabsKey').value=cfg.elevenlabs_api_key||'';
      document.getElementById('cfgElevenlabsVoice').value=cfg.elevenlabs_voice_id||'';
    }catch{saveMsg.textContent='Could not load config.';saveMsg.className='save-msg err';}
    sOverlay.classList.add('open');
  }

  function renderPL(id,paths){
    const c=document.getElementById(id);c.innerHTML='';
    paths.forEach(p=>{addPathRow(c,p);});
  }
  function addPathRow(container,value){
    const row=document.createElement('div');row.className='path-row';
    const inp=document.createElement('input');inp.className='field-input';inp.type='text';inp.value=value||'';inp.placeholder='/path/to/directory';
    const rm=document.createElement('button');rm.className='path-remove';rm.textContent='Ã—';rm.title='Remove';
    rm.addEventListener('click',()=>row.remove());
    row.appendChild(inp);row.appendChild(rm);container.appendChild(row);
    if(!value)inp.focus();
  }
  document.getElementById('addReadPath').addEventListener('click',()=>addPathRow(document.getElementById('readPathsList'),''));
  document.getElementById('addWritePath').addEventListener('click',()=>addPathRow(document.getElementById('writePathsList'),''));

  function gatherPaths(id){return Array.from(document.querySelectorAll('#'+id+' .field-input')).map(i=>i.value.trim()).filter(Boolean);}

  saveBtn.addEventListener('click',async()=>{
    saveMsg.textContent='Savingâ€¦';saveMsg.className='save-msg';
    try{
      const body={
        ollama_url:document.getElementById('cfgOllamaUrl').value.trim(),
        model:document.getElementById('cfgModel').value.trim(),
        port:document.getElementById('cfgPort').value.trim(),
        openclaw_dir:document.getElementById('cfgOpenclawDir').value.trim(),
        os:document.getElementById('cfgOs').value,
        read_paths:gatherPaths('readPathsList'),
        write_paths:gatherPaths('writePathsList'),
        audio_enabled:document.getElementById('cfgAudioEnabled').checked,
        elevenlabs_api_key:document.getElementById('cfgElevenlabsKey').value.trim(),
        elevenlabs_voice_id:document.getElementById('cfgElevenlabsVoice').value.trim(),
      };
      const r=await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const d=await r.json();saveMsg.textContent=d.message;saveMsg.className=d.success?'save-msg':'save-msg err';
      // Update audio state
      audioEnabled=body.audio_enabled;
      localStorage.setItem(AUDIO_KEY,audioEnabled?'true':'false');
      updateAudioBtnVisibility();
    }catch(e){saveMsg.textContent='Save failed: '+e.message;saveMsg.className='save-msg err';}
  });

  // Tabs
  function renderTabs(){
    tabsBar.querySelectorAll('.tab').forEach(t=>t.remove());
    sessions.forEach(s=>{
      const tab=document.createElement('div');tab.className='tab'+(s.id===activeId?' active':'');
      const lbl=document.createElement('span');lbl.className='tab-label';lbl.textContent=s.label;lbl.title=s.label;tab.appendChild(lbl);
      const cl=document.createElement('button');cl.className='tab-close';cl.textContent='Ã—';cl.addEventListener('click',e=>{e.stopPropagation();closeS(s.id);});tab.appendChild(cl);
      tab.addEventListener('click',()=>switchS(s.id));tabsBar.insertBefore(tab,newTabBtn);
    });
  }
  function switchS(id){if(streaming||id===activeId)return;activeId=id;persist();renderTabs();renderChat();input.focus();}
  function closeS(id){if(streaming)return;sessions=sessions.filter(s=>s.id!==id);if(!sessions.length)sessions.push(mkS());if(activeId===id)activeId=sessions[sessions.length-1].id;persist();renderTabs();renderChat();}
  newTabBtn.addEventListener('click',()=>{if(streaming)return;const s=mkS();sessions.push(s);activeId=s.id;persist();renderTabs();renderChat();input.focus();});

  // Chat
  function renderChat(){
    chatArea.innerHTML='';const s=cur();
    if(!s||!s.rendered.length){chatArea.innerHTML='<div class="welcome"><div class="welcome-icon">ðŸ©º</div><h2>What\'s the problem?</h2><p>Describe the issue you\'re experiencing. I\'ll diagnose it step by step, asking for permission before reading files, running commands, or making changes.</p></div>';return;}
    s.rendered.forEach((e,idx)=>{
      const w=document.createElement('div');w.className='message no-anim';
      if(e.role==='user')w.classList.add('message-user-wrap');
      const l=document.createElement('div');l.className='message-label'+(e.role==='assistant'?' assistant-label':'');l.textContent=e.role==='user'?'You':'DoctorClaw';
      const b=document.createElement('div');b.className='message-body '+e.role+'-body';
      b.innerHTML=fmt((e.content||'').replace(/\[ACTION:(READ_FILE|RUN_CMD|RUN_SCRIPT|WRITE_FILE):([^\]]*)\]/g,'').trim());
      w.appendChild(l);w.appendChild(b);
      if(e.role==='user'&&!streaming){
        const eb=document.createElement('button');eb.className='message-edit-btn';eb.title='Edit message';
        eb.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
        eb.addEventListener('click',()=>startEdit(idx,e.content,w,b));
        w.appendChild(eb);
      }
      chatArea.appendChild(w);
      if(e.actions)e.actions.forEach(a=>restoreAct(a,w));
    });scrollDown();
  }

  function restoreAct(act,after){
    const card=document.createElement('div');card.className='action-card no-anim';
    const bc=actBadge(act.type);
    const tl=actLabel(act.type);
    let h='<div class="action-header"><span class="action-type-badge '+bc+'">'+tl+'</span><span class="action-target" title="'+esc(act.target)+'">'+esc(act.target)+'</span></div><div class="action-body">';
    if(act.content)h+='<div class="action-content-preview">'+esc(act.content)+'</div>';
    if(act.status==='pending')h+='<div class="action-buttons"><button class="btn btn-approve" data-action="approve">âœ“ Approve</button><button class="btn btn-deny" data-action="deny">âœ• Deny</button></div>';
    else if(act.status==='approved')h+='<div class="action-buttons"><button class="btn btn-approve" disabled>âœ“ Approved</button></div>';
    else h+='<div class="action-buttons"><button class="btn btn-deny" disabled>âœ• Denied</button></div>';
    h+='<div class="action-result-container">';
    if(act.result){const c=act.status==='denied'?'denied':(act.resultSuccess?'success':'failure');h+='<div class="action-result '+c+'">'+esc(act.result)+'</div>';}
    h+='</div></div>';card.innerHTML=h;after.after(card);
    if(act.status==='pending')wireAct(card,act);
  }

  function wireAct(card,act){
    const ab=card.querySelector('[data-action="approve"]'),db=card.querySelector('[data-action="deny"]'),rc=card.querySelector('.action-result-container');
    ab.addEventListener('click',async()=>{
      ab.disabled=true;db.disabled=true;ab.textContent='Runningâ€¦';
      try{
        const res=await fetch('/api/execute',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:act.type,target:act.target,content:act.content})});
        const data=await res.json();act.status='approved';act.result=data.result;act.resultSuccess=data.success;persist();
        const r=document.createElement('div');r.className='action-result '+(data.success?'success':'failure');r.textContent=data.result;rc.appendChild(r);ab.textContent='âœ“ Approved';
        cur().conversation.push({role:'user',content:'[Result of '+act.type+' on "'+act.target+'"]: '+(data.success?'SUCCESS':'FAILED')+'\n'+data.result});persist();
        streaming=true;setSendBtnStreaming(true);try{await streamResp();}finally{streaming=false;setSendBtnStreaming(false);}
      }catch(err){const r=document.createElement('div');r.className='action-result failure';r.textContent='Error: '+err.message;rc.appendChild(r);ab.textContent='âœ“ Approve';ab.disabled=false;db.disabled=false;}
      scrollDown();
    });
    db.addEventListener('click',()=>{
      ab.disabled=true;db.disabled=true;db.textContent='âœ• Denied';act.status='denied';act.result='Action denied by user.';persist();
      const r=document.createElement('div');r.className='action-result denied';r.textContent='Action denied by user.';rc.appendChild(r);
      cur().conversation.push({role:'user',content:'[User DENIED the action: '+act.type+' on "'+act.target+'"]'});persist();scrollDown();
    });
  }

  function fmt(t){let h=esc(t);h=h.replace(/```(\w*)\n([\s\S]*?)```/g,'<pre><code>$2</code></pre>');h=h.replace(/`([^`]+)`/g,'<code>$1</code>');h=h.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');return h;}
  function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
  function scrollDown(){requestAnimationFrame(()=>{chatArea.scrollTop=chatArea.scrollHeight;});}
  function actBadge(t){return t==='READ_FILE'?'read':t==='RUN_CMD'?'cmd':t==='RUN_SCRIPT'?'script':'write';}
  function actLabel(t){return t==='READ_FILE'?'Read File':t==='RUN_CMD'?'Run Command':t==='RUN_SCRIPT'?'Run Script':'Write File';}
  const ACT_RE_STRIP=/\[ACTION:(READ_FILE|RUN_CMD|RUN_SCRIPT|WRITE_FILE):([^\]]*)\]/g;

  input.addEventListener('input',()=>{input.style.height='auto';input.style.height=Math.min(input.scrollHeight,160)+'px';});
  input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}});
  sendBtn.addEventListener('click',()=>{if(streaming){if(abortController)abortController.abort();}else{sendMsg();}});

  async function sendMsg(){
    const text=input.value.trim();if(!text||streaming)return;const s=cur();
    if(!s.conversation.length){s.label=text.length>30?text.slice(0,30)+'â€¦':text;renderTabs();}
    s.conversation.push({role:'user',content:text});s.rendered.push({role:'user',content:text});persist();
    input.value='';input.style.height='auto';renderChat();
    streaming=true;setSendBtnStreaming(true);try{await streamResp();}finally{streaming=false;setSendBtnStreaming(false);}input.focus();
  }

  async function streamResp(){
    const s=cur();abortController=new AbortController();
    const w=document.createElement('div');w.className='message';
    const l=document.createElement('div');l.className='message-label assistant-label';l.textContent='DoctorClaw';
    const b=document.createElement('div');b.className='message-body assistant-body';
    const dot=document.createElement('span');dot.className='streaming-dot';b.appendChild(dot);
    w.appendChild(l);w.appendChild(b);chatArea.appendChild(w);scrollDown();
    let full='',aborted=false,activeReader=null;
    abortController.signal.addEventListener('abort',()=>{aborted=true;if(activeReader)try{activeReader.cancel();}catch{}});
    try{
      const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:s.conversation})});
      if(aborted){if(dot.parentNode)dot.remove();w.remove();return;}
      if(!res.ok){let detail;try{const err=await res.json();detail=err.detail||err.error||'Unknown error';}catch{detail=res.statusText||'Request failed';}const errMsg='Error: '+detail;b.innerHTML=fmt(errMsg);s.conversation.push({role:'assistant',content:errMsg});s.rendered.push({role:'assistant',content:errMsg});persist();return;}
      activeReader=res.body.getReader();const dec=new TextDecoder();let buf='';
      while(true){const{done,value}=await activeReader.read();if(done||aborted)break;buf+=dec.decode(value,{stream:true});const lines=buf.split('\n');buf=lines.pop()||'';
        for(const line of lines){if(line.startsWith('data: ')){const p=line.slice(6).trim();if(p==='[DONE]')continue;try{const j=JSON.parse(p);if(j.message?.content){full+=j.message.content;b.innerHTML=fmt(full.replace(/\[ACTION:(READ_FILE|RUN_CMD|RUN_SCRIPT|WRITE_FILE):([^\]]*)\]/g,'').trim());scrollDown();}}catch{}}}}
    }catch(e){
      if(aborted){if(!full.trim()){if(dot.parentNode)dot.remove();w.remove();return;}}
      else{full+='\n\n[Connection interrupted: '+e.message+'. Try sending your message again.]';b.innerHTML=fmt(full.replace(ACT_RE_STRIP,'').trim());scrollDown();}
    }
    if(dot.parentNode)dot.remove();
    if(!full.trim())full='Hello! I\'m DoctorClaw, your system diagnostics assistant. How can I help you today?';
    b.innerHTML=fmt(full.replace(/\[ACTION:(READ_FILE|RUN_CMD|RUN_SCRIPT|WRITE_FILE):([^\]]*)\]/g,'').trim());
    s.conversation.push({role:'assistant',content:full});
    const entry={role:'assistant',content:full,actions:[]};
    if(!aborted){
      const RE=/\[ACTION:(READ_FILE|RUN_CMD|RUN_SCRIPT|WRITE_FILE):([^\]]+)\]/g;let m;
      while((m=RE.exec(full))!==null){
        const type=m[1];let target,content;
        if(type==='WRITE_FILE'||type==='RUN_SCRIPT'){const ci=m[2].indexOf(':');if(ci>-1){target=m[2].slice(0,ci);content=m[2].slice(ci+1);}else{target=m[2];content=null;}}else{target=m[2];content=null;}
        const act={type,target,content,status:'pending',result:null,resultSuccess:null};entry.actions.push(act);
        const card=document.createElement('div');card.className='action-card';
        const bc=actBadge(type);
        const tl=actLabel(type);
        let ch='<div class="action-header"><span class="action-type-badge '+bc+'">'+tl+'</span><span class="action-target" title="'+esc(target)+'">'+esc(target)+'</span></div><div class="action-body">';
        if(content)ch+='<div class="action-content-preview">'+esc(content)+'</div>';
        ch+='<div class="action-buttons"><button class="btn btn-approve" data-action="approve">âœ“ Approve</button><button class="btn btn-deny" data-action="deny">âœ• Deny</button></div><div class="action-result-container"></div></div>';
        card.innerHTML=ch;w.after(card);wireAct(card,act);
      }
    }
    s.rendered.push(entry);persist();scrollDown();
    // Trigger TTS if audio is enabled and response wasn't aborted
    if(audioEnabled&&!aborted&&full.trim()){
      const ttsChunks=parseResponseForTTS(full);
      if(ttsChunks.length) queueTTS(ttsChunks);
    }
  }

  function setSendBtnStreaming(on){
    if(on){sendBtn.innerHTML=STOP_ICON;sendBtn.classList.add('stopping');sendBtn.disabled=false;sendBtn.title='Stop';}
    else{sendBtn.innerHTML=SEND_ICON;sendBtn.classList.remove('stopping');sendBtn.disabled=false;sendBtn.title='Send';}
  }

  function startEdit(renderedIdx,originalContent,msgWrap,bodyEl){
    if(streaming)return;
    if(msgWrap.querySelector('.edit-container'))return;
    bodyEl.style.display='none';
    const ec=document.createElement('div');ec.className='edit-container';
    const ta=document.createElement('textarea');ta.className='edit-textarea';ta.value=originalContent;
    ta.rows=Math.min(Math.max(originalContent.split('\n').length,2),8);
    const acts=document.createElement('div');acts.className='edit-actions';
    const notice=document.createElement('div');notice.className='branch-notice';notice.textContent='Editing will branch the conversation from this point';
    const cancelB=document.createElement('button');cancelB.className='btn btn-deny';cancelB.textContent='Cancel';
    const saveB=document.createElement('button');saveB.className='btn btn-approve';saveB.textContent='Save & Submit';
    acts.appendChild(cancelB);acts.appendChild(saveB);
    ec.appendChild(ta);ec.appendChild(notice);ec.appendChild(acts);msgWrap.appendChild(ec);ta.focus();
    const editBtnEl=msgWrap.querySelector('.message-edit-btn');if(editBtnEl)editBtnEl.style.display='none';
    cancelB.addEventListener('click',()=>{ec.remove();bodyEl.style.display='';if(editBtnEl)editBtnEl.style.display='';});
    saveB.addEventListener('click',()=>{const t=ta.value.trim();if(t)submitEdit(renderedIdx,t);});
    ta.addEventListener('keydown',e=>{
      if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();const t=ta.value.trim();if(t)submitEdit(renderedIdx,t);}
      if(e.key==='Escape'){ec.remove();bodyEl.style.display='';if(editBtnEl)editBtnEl.style.display='';}
    });
  }

  function getConvIdx(s,renderedIdx){
    let ri=0;
    for(let ci=0;ci<s.conversation.length;ci++){
      if(ri>=s.rendered.length)break;
      if(s.conversation[ci].role===s.rendered[ri].role&&s.conversation[ci].content===s.rendered[ri].content){if(ri===renderedIdx)return ci;ri++;}
    }
    return -1;
  }

  async function submitEdit(renderedIdx,newText){
    if(streaming)return;const s=cur();
    const convIdx=getConvIdx(s,renderedIdx);if(convIdx===-1)return;
    s.conversation=s.conversation.slice(0,convIdx);
    s.rendered=s.rendered.slice(0,renderedIdx);
    s.conversation.push({role:'user',content:newText});
    s.rendered.push({role:'user',content:newText});
    if(renderedIdx===0){s.label=newText.length>30?newText.slice(0,30)+'â€¦':newText;renderTabs();}
    persist();renderChat();
    streaming=true;setSendBtnStreaming(true);try{await streamResp();}finally{streaming=false;setSendBtnStreaming(false);}input.focus();
  }

  // â”€â”€ Audio Feature: Speech-to-Text (MediaRecorder + ElevenLabs Scribe) â”€â”€

  const MIC_ICON='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';
  const STOP_MIC_ICON='<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>';

  let isRecording=false, mediaRecorder=null, mediaStream=null, audioChunks=[], sttBaseText='';

  function updateAudioBtnVisibility(){
    if(audioEnabled) audioBtn.classList.add('visible');
    else { audioBtn.classList.remove('visible'); if(isRecording) stopRecording(); }
  }

  function getSupportedMimeType(){
    const types=['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4'];
    for(const t of types) if(MediaRecorder.isTypeSupported(t)) return t;
    return '';
  }

  function startRecording(){
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
      mediaStream=stream;
      const mimeType=getSupportedMimeType();
      mediaRecorder=new MediaRecorder(stream, mimeType?{mimeType}:{});
      audioChunks=[];

      mediaRecorder.ondataavailable=e=>{
        if(e.data.size>0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop=async()=>{
        if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop());mediaStream=null;}
        if(!audioChunks.length) return;

        const mType=mediaRecorder.mimeType||'audio/webm';
        const audioBlob=new Blob(audioChunks,{type:mType});
        audioChunks=[];

        // Convert to base64 and send for transcription
        const reader=new FileReader();
        reader.onloadend=async()=>{
          const base64=reader.result.split(',')[1];
          if(!base64) return;

          const prevPlaceholder=input.placeholder;
          input.placeholder='Transcribingâ€¦';
          input.disabled=true;

          try{
            const resp=await fetch('/api/stt',{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body:JSON.stringify({audio:base64,mimeType:mType}),
            });
            if(resp.ok){
              const data=await resp.json();
              if(data.text){
                const sep=sttBaseText?' ':'';
                input.value=sttBaseText+sep+data.text;
                input.style.height='auto';
                input.style.height=Math.min(input.scrollHeight,160)+'px';
              }
            }else{
              const err=await resp.json().catch(()=>({}));
              console.warn('STT error:',err.error||'Unknown error');
            }
          }catch(e){console.warn('STT request failed:',e);}

          input.placeholder=prevPlaceholder;
          input.disabled=false;
          input.focus();
        };
        reader.readAsDataURL(audioBlob);
      };

      sttBaseText=input.value;
      isRecording=true;
      audioBtn.innerHTML=STOP_MIC_ICON;
      audioBtn.classList.add('recording');
      audioBtn.title='Stop listening';
      mediaRecorder.start();
    }).catch(err=>{
      console.warn('Microphone access denied:',err);
    });
  }

  function stopRecording(){
    isRecording=false;
    audioBtn.innerHTML=MIC_ICON;
    audioBtn.classList.remove('recording');
    audioBtn.title='Voice input';
    if(mediaRecorder&&mediaRecorder.state!=='inactive'){
      mediaRecorder.stop();
    }else{
      if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop());mediaStream=null;}
    }
  }

  audioBtn.addEventListener('click',()=>{
    if(isRecording) stopRecording();
    else startRecording();
  });

  // â”€â”€ Text-to-Speech via ElevenLabs â”€â”€

  let ttsQueue=[], ttsPlaying=false, currentAudio=null;

  function showTTSIndicator(on){
    if(on) ttsIndicator.classList.add('active');
    else ttsIndicator.classList.remove('active');
  }

  async function playNextTTS(){
    if(!ttsQueue.length){ttsPlaying=false;showTTSIndicator(false);return;}
    ttsPlaying=true;showTTSIndicator(true);
    const text=ttsQueue.shift();
    try{
      const resp=await fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
      if(!resp.ok){playNextTTS();return;}
      const blob=await resp.blob();
      const url=URL.createObjectURL(blob);
      currentAudio=new Audio(url);
      currentAudio.onended=()=>{URL.revokeObjectURL(url);currentAudio=null;playNextTTS();};
      currentAudio.onerror=()=>{URL.revokeObjectURL(url);currentAudio=null;playNextTTS();};
      currentAudio.play().catch(()=>{URL.revokeObjectURL(url);currentAudio=null;playNextTTS();});
    }catch{currentAudio=null;playNextTTS();}
  }

  function queueTTS(chunks){
    ttsQueue.push(...chunks);
    if(!ttsPlaying) playNextTTS();
  }

  function stopTTS(){
    ttsQueue=[];
    if(currentAudio){try{currentAudio.pause();}catch{}currentAudio=null;}
    ttsPlaying=false;showTTSIndicator(false);
  }

  ttsStopBtn.addEventListener('click',stopTTS);

  function parseResponseForTTS(text){
    // Remove action markers
    text=text.replace(/\[ACTION:(READ_FILE|RUN_CMD|RUN_SCRIPT|WRITE_FILE):([^\]]*)\]/g,'').trim();
    if(!text) return [];
    const chunks=[];
    // Split around code blocks
    const parts=text.split(/(```[\s\S]*?```)/g);
    let consecutiveCodeBlocks=0;
    for(let i=0;i<parts.length;i++){
      const part=parts[i].trim();
      if(!part) continue;
      if(part.startsWith('```')){
        consecutiveCodeBlocks++;
      } else {
        // Flush code block announcement
        if(consecutiveCodeBlocks>0){
          chunks.push(consecutiveCodeBlocks===1?'See code block.':'See code blocks.');
          consecutiveCodeBlocks=0;
        }
        // Split into paragraph-sized chunks on double newlines
        const paragraphs=part.split(/\n\n+/);
        for(const p of paragraphs){
          const cleaned=p.replace(/\n/g,' ').trim();
          if(cleaned) chunks.push(cleaned);
        }
      }
    }
    // Handle trailing code blocks
    if(consecutiveCodeBlocks>0){
      chunks.push(consecutiveCodeBlocks===1?'See code block.':'See code blocks.');
    }
    return chunks;
  }

  // Fetch audio config on page load
  (async function loadAudioState(){
    try{
      const r=await fetch('/api/config');const cfg=await r.json();
      audioEnabled=!!cfg.audio_enabled;
      localStorage.setItem(AUDIO_KEY,audioEnabled?'true':'false');
      updateAudioBtnVisibility();
    }catch{/* keep localStorage value */}
  })();

  updateAudioBtnVisibility();
  renderTabs();renderChat();input.focus();
})();
</script>
</body>
</html>
